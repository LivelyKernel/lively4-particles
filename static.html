<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Particles</title>
    <link rel="stylesheet" href="./css/index.css" media="screen">
    <script src="./google-blockly/blockly_compressed.js"></script>
    <script src="./google-blockly/javascript_compressed.js"></script>
    <script src="./google-blockly/msg/js/en.js"></script>
    <!-- <script src="./NeilFraser-JS-Interpreter/acorn_interpreter.js"></script> -->
  </head>
  <body>
    <lively-turtle-canvas id="tCanvas">
    Test
    </lively-turtle-canvas>
    <!-- controls compatible wth ace editor -->
    <br>
    <button type="button" id="StepButton" onclick="step()">Step</button>
    <button type="button" id="StartButton" onclick="startSim()">Start</button>
    <button type="button" id="PauseButton" onclick="pauseSim()" disabled="">Pause</button>
    <button type="button" id="ResetButton" onclick="reset()">Reset</button>
    <br>
    <input id="clearColor" type="color" value="#FFFFFF">
    <br>
    <span id="info">(reset)</span>

    <lively-window title="Particle Spawning" style="z-index: 100;">
      <juicy-ace-editor id="spawningCode">
      for (var i = 0; i &lt; 100; i++)
      {
        var part = {
          turtle: {
            pos: {
              x: 300,
              y: 400
            },
            heading: (Math.random() * 120 + 210)
          },
          velocity: (Math.random() * 128 + 32)
        };
  
        particles.push(part);
      }
      </juicy-ace-editor>
    </lively-window>

    <div id="blocklyDiv">
    </div>

    <xml id="toolbox" style="display: none">
      <category name="Control" colour="210">
        <block type="controls_if"></block>
        <block type="controls_repeat_ext"></block>
      </category>
      <category name="Logic" colour="120">
        <block type="logic_compare"></block>
      </category>
      <category name="Math" colour="20">
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
        <block type="math_random"></block>
      </category>
      <category name="Text" colour="330">
        <block type="text"></block>
        <block type="text_print"></block>
      </category>
      <category name="Custom" colour="290">
        <block type="turtle_penup"></block>
        <block type="turtle_pendown"></block>
        <block type="turtle_setcolor"></block>
        <block type="turtle_forward"></block>
        <block type="turtle_backward"></block>
        <block type="turtle_right"></block>
        <block type="turtle_left"></block>
      </category>
    </xml>
    <script type="text/javascript">
      // workspace
      var workspace = Blockly.inject('blocklyDiv',
          {toolbox: document.getElementById('toolbox')});

      // particles
      var particles = [];
      var stepNumber = 0;
      var running = false;
      var requestedFrame = 0;

      var can = document.getElementById("tCanvas");
      can.initialize();
      var turtle = can.turtle;
      var canvas = can.canvas;
      var context = can.context;

      // update code
      Blockly.JavaScript.addReservedWords('code');
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      // var myInterpreter = new Interpreter(code); <-- try later

      function myUpdateFunction(event) {
        code = Blockly.JavaScript.workspaceToCode(workspace);
        saveMovementCode();
      }
      workspace.addChangeListener(myUpdateFunction);

      // custom buttons, turtle_penup
      Blockly.Blocks['turtle_penup'] = {
        /**
         * Block for pen up
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendDummyInput()
              .appendField('penUp');
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };

      Blockly.JavaScript['turtle_penup'] = function(block) {
        // Generate JavaScript for setting pen up.
        return 'turtle.penUp();\n';
      };

      // custom buttons, turtle_pendown
      Blockly.Blocks['turtle_pendown'] = {
        /**
         * Block for pen up
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendDummyInput()
              .appendField('penDown');
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };

      Blockly.JavaScript['turtle_pendown'] = function(block) {
        // Generate JavaScript for setting pen up.
        return 'turtle.penDown();\n';
      };

      // turtle_setcolor
      Blockly.Blocks['turtle_setcolor'] = {
        /**
         * Block for moving forward
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendValueInput('VALUE')
              .setCheck('Number') // validate
              .appendField('setColor');
          this.appendValueInput('VALUE1')
              .setCheck('Number'); // validate
          this.appendValueInput('VALUE2')
              .setCheck('Number'); // validate
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };


      Blockly.JavaScript['turtle_setcolor'] = function(block) {
        var value = Blockly.JavaScript.valueToCode(block, 'VALUE',
            Blockly.JavaScript.ORDER_NONE) || '0';
        var value1 = Blockly.JavaScript.valueToCode(block, 'VALUE1',
            Blockly.JavaScript.ORDER_NONE) || '0';
        var value2 = Blockly.JavaScript.valueToCode(block, 'VALUE2',
            Blockly.JavaScript.ORDER_NONE) || '0';
        return 'turtle.setColor' +
            '(' + value + ', ' + value1 + ', ' + value2 + ');\n';
      };

      // math_random
      Blockly.Blocks['math_random'] = {
        /**
         * Block for math random
         * @this Blockly.Block
         */
        init: function() {
          this.setOutput(true, 'Math.random');
        }
      };

      Blockly.JavaScript['math_random'] = function(block) {
        // Generate JavaScript for setting math random.
        return 'Math.random()';
      };

      // turtle_forward
      Blockly.Blocks['turtle_forward'] = {
        /**
         * Block for moving forward
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendValueInput('VALUE')
              .setCheck('Number') // validate
              .appendField('turtle forward');
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };


      Blockly.JavaScript['turtle_forward'] = function(block) {
        var value = Blockly.JavaScript.valueToCode(block, 'VALUE',
            Blockly.JavaScript.ORDER_NONE) || '0';
        return 'turtle.forward' +
            '(' + value + ');\n';
      };

      // turtle_backward
      Blockly.Blocks['turtle_backward'] = {
        /**
         * Block for moving forward
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendValueInput('VALUE')
              .setCheck('Number') // validate
              .appendField('turtle backward');
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };


      Blockly.JavaScript['turtle_backward'] = function(block) {
        var value = Blockly.JavaScript.valueToCode(block, 'VALUE',
            Blockly.JavaScript.ORDER_NONE) || '0';
        return 'turtle.backward' +
            '(' + value + ');\n';
      };

      // turtle_left
      Blockly.Blocks['turtle_left'] = {
        /**
         * Block for moving forward
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendValueInput('VALUE')
              .setCheck('Number') // validate
              .appendField('turtle left');
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };


      Blockly.JavaScript['turtle_left'] = function(block) {
        var value = Blockly.JavaScript.valueToCode(block, 'VALUE',
            Blockly.JavaScript.ORDER_NONE) || '0';
        return 'turtle.left' +
            '(' + value + ');\n';
      };

      // turtle_right
      Blockly.Blocks['turtle_right'] = {
        /**
         * Block for moving forward
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendValueInput('VALUE')
              .setCheck('Number') // validate
              .appendField('turtle right');
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };


      Blockly.JavaScript['turtle_right'] = function(block) {
        var value = Blockly.JavaScript.valueToCode(block, 'VALUE',
            Blockly.JavaScript.ORDER_NONE) || '0';
        return 'turtle.right' +
            '(' + value + ');\n';
      };

      function saveSpawnCode()
      {
        this.spawnFunction = eval("() => {" + document.getElementById("spawningCode").value + "}")
      }

      function saveMovementCode()
      {
        this.movementFunction = eval("(particle) => {" + code + "particle.velocity *= 0.9;\nreturn particle.velocity > 5;\n" + "}");
      }

      function clearThis()
      {
        var color = document.getElementById("clearColor").value;
        can.clearCanvas(color);
      }

      function step()
      {
        clearThis();
        stepNumber++;

        var startTime = new Date();
        spawn();
        moveAndDraw();
        var endTime = new Date();

        var elapsed = endTime - startTime;
        var partCount = particles.length;

        document.getElementById("info").innerHTML = partCount.toString(10) + " Particles, " + elapsed.toString(10) + "ms";

        if (running)
          requestedFrame = requestAnimationFrame(step);
      }

      function spawn()
      {
        spawnFunction();
      }

      function moveAndDraw()
      {
        newParts = [];
        for (part of particles)
        {
          turtle.setState(part.turtle);
          var keep = movementFunction(part);
          console.log(movementFunction);
          part.turtle = turtle.getState();
          if (keep)
            newParts.push(part);
        }
        particles = newParts;
      }

      function startSim()
      {
        requestedFrame = requestAnimationFrame(step);

        document.getElementById("StepButton").disabled = true;
        document.getElementById("StartButton").disabled = true;
        document.getElementById("PauseButton").disabled = false;

        running = true;
      }

      function pauseSim()
      {
        running = false;
        cancelAnimationFrame(requestedFrame);

        document.getElementById("StepButton").disabled = false;
        document.getElementById("StartButton").disabled = false;
        document.getElementById("PauseButton").disabled = true;
      }

      function reset()
      {
        if (running)
          pauseSim();
        particles = [];
        stepNumber = 0;
        clearThis();
        document.getElementById("info").innerHTML = "(reset)";
      }

      function init()
      {
        saveMovementCode();
        saveSpawnCode();

        var spawner = document.getElementById("spawningCode");
        // var mover = document.getElementById("movementCode");

        spawner.changeMode("javascript");
        spawner.customizeEditor();
        spawner.doSave = () => {saveSpawnCode()};

        // mover.changeMode("javascript");
        // mover.customizeEditor();
        // mover.doSave = () => {saveMovementCode()};
      };

      init();

    </script>
  </body>
</html>
