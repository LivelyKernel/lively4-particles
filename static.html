


    <meta charset="utf-8">
    <title>Particles</title>
    <link rel="stylesheet" href="./css/index.css" media="screen">
    <script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-particles/google-blockly/blockly_compressed.js"></script>
    <script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-particles/google-blockly/javascript_compressed.js"></script>
    <script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-particles/google-blockly/msg/js/en.js"></script>
    <!-- <script src="./NeilFraser-JS-Interpreter/acorn_interpreter.js"></script> -->


    <lively-turtle-canvas id="tCanvas">
    Test
    </lively-turtle-canvas>
    <!-- controls compatible wth ace editor -->
    <br>
    <button type="button" id="StepButton" onclick="step()">Step</button>
    <button type="button" id="StartButton" onclick="startSim()">Start</button>
    <button type="button" id="PauseButton" onclick="pauseSim()" disabled="">Pause</button>
    <button type="button" id="ResetButton" onclick="reset()">Reset</button>
    <br>
    <input type="number" id="particleCount" value="1">
    <br>
    <input id="clearColor" type="color" value="#FFFFFF">
    <br>
    <span id="info">0 Particles, 0ms</span>

    <!-- <lively-window title="Particle Spawning">
      <juicy-ace-editor id="spawningCode">
{
  pos: {
    x: (Math.random()) * 300 + 150,
    y: (Math.random()) * 400 + 100
  },
  heading: (Math.random() * 360),
  velocity: (Math.random() * 16 + 16)
}
      </juicy-ace-editor>
    </lively-window> -->

    <div id="movementCodeDiv" style="height: 480px; width: 600px;">
    <!-- <div class="injectionDiv" dir="LTR"><div class="blocklyToolboxDiv" dir="LTR" style="left: 0px; height: 150px;"><div class="blocklyTreeRoot" id=":0" role="tree" aria-selected="false" aria-expanded="false" aria-level="0" aria-labelledby=":0.label" hidefocus="true" tabindex="0"><div class="blocklyTreeRow blocklyHidden" style="padding-left:0px;"><span style="display:inline-block;" class="" role="presentation"></span><span class="blocklyTreeLabel" id=":0.label"></span><span></span></div><div style="background-position:-100px 0;" role="group"><div class="" id=":1" role="treeitem" aria-selected="false" aria-expanded="false" aria-level="1" aria-labelledby=":1.label" aria-setsize="5" aria-posinset="1"><div class="blocklyTreeRow" style="padding-left: 0px; border-left: 8px solid rgb(91, 128, 165);"><span role="presentation"></span><span style="display:inline-block;" class="blocklyTreeIcon blocklyTreeIconNone" role="presentation"></span><span class="blocklyTreeLabel" id=":1.label">Control</span><span></span></div><div style="background-position:0px 0;display:none;" role="group"></div></div><div class="" id=":2" role="treeitem" aria-selected="false" aria-expanded="false" aria-level="1" aria-labelledby=":2.label" aria-setsize="5" aria-posinset="2"><div class="blocklyTreeRow" style="padding-left: 0px; border-left: 8px solid rgb(91, 165, 91);"><span role="presentation"></span><span style="display:inline-block;" class="blocklyTreeIcon blocklyTreeIconNone" role="presentation"></span><span class="blocklyTreeLabel" id=":2.label">Logic</span><span></span></div><div style="background-position:0px 0;display:none;" role="group"></div></div><div class="" id=":3" role="treeitem" aria-selected="false" aria-expanded="false" aria-level="1" aria-labelledby=":3.label" aria-setsize="5" aria-posinset="3"><div class="blocklyTreeRow" style="padding-left: 0px; border-left: 8px solid rgb(165, 116, 91);"><span role="presentation"></span><span style="display:inline-block;" class="blocklyTreeIcon blocklyTreeIconNone" role="presentation"></span><span class="blocklyTreeLabel" id=":3.label">Math</span><span></span></div><div style="background-position:0px 0;display:none;" role="group"></div></div><div class="" id=":4" role="treeitem" aria-selected="false" aria-expanded="false" aria-level="1" aria-labelledby=":4.label" aria-setsize="5" aria-posinset="4"><div class="blocklyTreeRow" style="padding-left: 0px; border-left: 8px solid rgb(165, 91, 128);"><span role="presentation"></span><span style="display:inline-block;" class="blocklyTreeIcon blocklyTreeIconNone" role="presentation"></span><span class="blocklyTreeLabel" id=":4.label">Text</span><span></span></div><div style="background-position:0px 0;display:none;" role="group"></div></div><div class="" id=":5" role="treeitem" aria-selected="false" aria-expanded="false" aria-level="1" aria-labelledby=":5.label" aria-setsize="5" aria-posinset="5"><div class="blocklyTreeRow" style="padding-left: 0px; border-left: 8px solid rgb(153, 91, 165);"><span role="presentation"></span><span style="display:inline-block;" class="blocklyTreeIcon blocklyTreeIconNone" role="presentation"></span><span class="blocklyTreeLabel" id=":5.label">Custom</span><span></span></div><div style="background-position:-100px 0;display:none;" role="group"></div></div></div></div></div><svg xmlns="http://www.w3.org/2000/svg" xmlns:html="http://www.w3.org/1999/xhtml" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="blocklySvg" width="579px" height="150px"><defs><filter id="blocklyEmbossFilter7007830196335496"><feGaussianBlur in="SourceAlpha" stdDeviation="1" result="blur"></feGaussianBlur><feSpecularLighting in="blur" surfaceScale="1" specularConstant="0.5" specularExponent="10" lighting-color="white" result="specOut"><fePointLight x="-5000" y="-10000" z="20000"></fePointLight></feSpecularLighting><feComposite in="specOut" in2="SourceAlpha" operator="in" result="specOut"></feComposite><feComposite in="SourceGraphic" in2="specOut" operator="arithmetic" k1="0" k2="1" k3="1" k4="0"></feComposite></filter><pattern id="blocklyDisabledPattern7007830196335496" patternUnits="userSpaceOnUse" width="10" height="10"><rect width="10" height="10" fill="#aaa"></rect><path d="M 0 0 L 10 10 M 10 0 L 0 10" stroke="#cc0"></path></pattern><pattern id="blocklyGridPattern7007830196335496" patternUnits="userSpaceOnUse" width="100" height="100" x="100" y="6.999999999999972"></pattern></defs><g class="blocklyWorkspace"><rect height="100%" width="100%" class="blocklyMainBackground" style="fill: url(&quot;#blocklyGridPattern7007830196335496&quot;);"></rect><g class="blocklyTrash" transform="translate(487,45)" style="opacity: 0.4;"><clipPath id="blocklyTrashBodyClipPath14091460094525488"><rect width="47" height="44" y="16"></rect></clipPath><image width="96" x="0" height="124" y="-32" clip-path="url(#blocklyTrashBodyClipPath14091460094525488)" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://blockly-demo.appspot.com/static/media/sprites.png"></image><clipPath id="blocklyTrashLidClipPath14091460094525488"><rect width="47" height="16"></rect></clipPath><image width="96" x="0" height="124" y="-32" clip-path="url(#blocklyTrashLidClipPath14091460094525488)" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://blockly-demo.appspot.com/static/media/sprites.png" transform="rotate(0,43,14)"></image></g><g class="blocklyBlockCanvas" transform="translate(100,6.999999999999972) scale(1)"></g><g class="blocklyBubbleCanvas" transform="translate(100,6.999999999999972) scale(1)"></g><rect height="25" width="25" class="blocklyScrollbarBackground" x="553.5" y="124.5"></rect><g class="blocklyScrollbarVertical" transform="translate(553.5,0.5)"><rect class="blocklyScrollbarBackground" width="25" height="124"></rect><rect class="blocklyScrollbarHandle" rx="10" ry="10" width="20" x="2.5" height="65.03496503496503" y="58.965034965034974"></rect></g><g class="blocklyScrollbarHorizontal" transform="translate(93.5,124.5)"><rect class="blocklyScrollbarBackground" height="25" width="460"></rect><rect class="blocklyScrollbarHandle" rx="10" ry="10" height="20" y="2.5" width="233.36116910229646" x="226.63883089770354"></rect></g></g><g class="blocklyFlyout"><path class="blocklyFlyoutBackground"></path><g class="blocklyWorkspace"><g class="blocklyBlockCanvas"></g><g class="blocklyBubbleCanvas"></g><g class="blocklyScrollbarVertical"><rect class="blocklyScrollbarBackground" width="25"></rect><rect class="blocklyScrollbarHandle" rx="10" ry="10" width="20" x="2.5"></rect></g></g></g></svg></div> -->
    </div>

    <xml id="toolbox" style="display: none">
      <category name="Control" colour="210">
        <block type="controls_if"></block>
        <block type="controls_repeat_ext"></block>
      </category>
      <category name="Logic" colour="120">
        <block type="logic_compare"></block>
      </category>
      <category name="Math" colour="20">
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
        <block type="math_random"></block>
      </category>
      <category name="Text" colour="330">
        <block type="text"></block>
        <block type="text_print"></block>
      </category>
      <category name="Custom" colour="290">
        <block type="turtle_pen"></block>
        <block type="turtle_setcolor"></block>
        <block type="turtle_move"></block>
      </category>
    </xml>
    <script type="text/javascript">
      // workspace
      var workspace = Blockly.inject('movementCodeDiv',
          {toolbox: document.getElementById('toolbox')});

      // particles
      var particles = [];
      var stepNumber = 0;
      var running = false;
      var requestedFrame = 0;

      var spawnCode = "";
      var movementCode = (particle) => {};

      var can = document.getElementById("tCanvas");
      can.initialize();
      var turtle = can.turtle;
      var canvas = can.canvas;
      var context = can.context;

      // update code
      Blockly.JavaScript.addReservedWords('code');
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      // var myInterpreter = new Interpreter(code); <-- try later

      function myUpdateFunction(event) {
        code = Blockly.JavaScript.workspaceToCode(workspace);
        saveMovementCode();
      }
      workspace.addChangeListener(myUpdateFunction);

      // custom buttons, turtle_penup
      Blockly.Blocks['turtle_pen'] = {
        /**
         * Block for pen up
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendDummyInput()
              .appendField('pen:')
              .appendField(new Blockly.FieldDropdown([
                             ['up', 'Up'],
                             ['down', 'Down']
                           ]),
                           'VALUE');
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };

      Blockly.JavaScript['turtle_pen'] = function(block) {
        // Generate JavaScript for setting pen up.
        var value = block.getFieldValue('VALUE');
        return 'turtle.pen' + value + '();\n';
      };

      // turtle_setcolor
      Blockly.Blocks['turtle_setcolor'] = {
        /**
         * Block for moving forward
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendValueInput('VALUE')
              .setCheck('Number') // validate
              .appendField('setColor');
          this.appendValueInput('VALUE1')
              .setCheck('Number'); // validate
          this.appendValueInput('VALUE2')
              .setCheck('Number'); // validate
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };


      Blockly.JavaScript['turtle_setcolor'] = function(block) {
        var value = Blockly.JavaScript.valueToCode(block, 'VALUE',
            Blockly.JavaScript.ORDER_NONE) || '0';
        var value1 = Blockly.JavaScript.valueToCode(block, 'VALUE1',
            Blockly.JavaScript.ORDER_NONE) || '0';
        var value2 = Blockly.JavaScript.valueToCode(block, 'VALUE2',
            Blockly.JavaScript.ORDER_NONE) || '0';
        return 'turtle.setColor' +
            '(' + value + ', ' + value1 + ', ' + value2 + ');\n';
      };

      // math_random
      Blockly.Blocks['math_random'] = {
        /**
         * Block for math random
         * @this Blockly.Block
         */
        init: function() {
          this.appendDummyInput()
              .appendField('Math.random()');
          this.setOutput(true, 'String');
        }
      };

      Blockly.JavaScript['math_random'] = function(block) {
        // Generate JavaScript for setting math random.
        return 'Math.random()';
      };

      // turtle_forward
      Blockly.Blocks['turtle_move'] = {
        /**
         * Block for moving
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendDummyInput()
              .appendField('move')
              .appendField(new Blockly.FieldDropdown([
                             ['forward', 'forward'],
                             ['backward', 'backward'],
                             ['left', 'left'],
                             ['right', 'right']
                           ]),
                           'DIRECTION');
          this.appendValueInput('VALUE');
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };


      Blockly.JavaScript['turtle_move'] = function(block) {
        var direction = block.getFieldValue('DIRECTION');
        var value = block.getFieldValue('VALUE');

        return 'turtle.'+ direction +
            '(' + value + ');\n';
      };

      function saveSpawnCode()
      {
        this.spawnCode = "(function () { return " + document.getElementById("spawningCode").value + ";})()";
      }

      function saveMovementCode()
      {
        this.movementFunction = eval("(particle) => {" + code + "}");
      }

      function clearThis()
      {
        var color = document.getElementById("clearColor").value;
        can.clearCanvas(color);
      }

      function step()
      {
        clearThis();
        stepNumber++;

        var startTime = new Date();
        spawn();
        moveAndDraw();
        var endTime = new Date();

        var elapsed = endTime - startTime;
        var partCount = particles.length;

        document.getElementById("info").innerHTML = partCount.toString(10) + " Particles, " + elapsed.toString(10) + "ms";

        if (running)
          requestedFrame = requestAnimationFrame(step);
      }

      function spawn()
      {
        const targetCount = document.getElementById("particleCount").value;

        while (particles.length < targetCount)
        {
          var newParticle = eval(spawnCode);
          particles.push(newParticle);
        }

        if (particles.length > targetCount)
        {
          particles = particles.slice(0, targetCount);
        }
      }

      function moveAndDraw()
      {
        for (part of particles)
        {
          turtle.setState(part);
          movementFunction(part);
          part = part.assign(turtle.getState());
        }
      }

      function startSim()
      {
        requestedFrame = requestAnimationFrame(step);

        document.getElementById("StepButton").disabled = true;
        document.getElementById("StartButton").disabled = true;
        document.getElementById("PauseButton").disabled = false;

        running = true;
      }

      function pauseSim()
      {
        running = false;
        cancelAnimationFrame(requestedFrame);

        document.getElementById("StepButton").disabled = false;
        document.getElementById("StartButton").disabled = false;
        document.getElementById("PauseButton").disabled = true;
      }

      function reset()
      {
        if (running)
          pauseSim();
        particles = [];
        stepNumber = 0;
        clearThis();
        document.getElementById("info").innerHTML = "(reset)";
      }

      function init()
      {
        saveMovementCode();
        saveSpawnCode();

        var spawner = document.getElementById("spawningCode");
        // var mover = document.getElementById("movementCode");

        spawner.changeMode("javascript");
        spawner.customizeEditor();
        spawner.doSave = () => {saveSpawnCode()};

        // mover.changeMode("javascript");
        // mover.customizeEditor();
        // mover.doSave = () => {saveMovementCode()};
      };

      init();

    </script>
