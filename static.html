


    <meta charset="utf-8">
    <title>Particles</title>
    <link rel="stylesheet" href="./css/index.css" media="screen">
    <script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-particles/google-blockly/blockly_compressed.js"></script>
    <script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-particles/google-blockly/javascript_compressed.js"></script>
    <script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-particles/google-blockly/msg/js/en.js"></script>
    <!-- <script src="./NeilFraser-JS-Interpreter/acorn_interpreter.js"></script> -->


    <lively-turtle-canvas id="tCanvas">
    Test
    </lively-turtle-canvas>
    <!-- controls compatible wth ace editor -->
    <br>
    <button type="button" id="StepButton" onclick="step()">Step</button>
    <button type="button" id="StartButton" onclick="startSim()">Start</button>
    <button type="button" id="PauseButton" onclick="pauseSim()" disabled="">Pause</button>
    <button type="button" id="ResetButton" onclick="reset()">Reset</button>
    <br>
    <input type="number" id="particleCount" value="1">
    <br>
    <input id="clearColor" type="color" value="#FFFFFF">
    <br>
    <span id="info">0 Particles, 0ms</span>

     <lively-window title="Particle Spawning">
      <juicy-ace-editor id="spawningCode">
{
  pos: {
    x: (Math.random()) * 300 + 150,
    y: (Math.random()) * 400 + 100
  },
  heading: (Math.random() * 360),
  velocity: (Math.random() * 16 + 16)
}
      </juicy-ace-editor>
    </lively-window>

    <div id="spawnCodeDiv" style="height: 200px; width: 400px;">
    </div>

    <div id="movementCodeDiv" style="height: 400px; width: 600px;">
    </div>

    <xml id="toolbox" style="display: none">
      <category name="Control" colour="210">
        <block type="controls_if"></block>
        <block type="controls_repeat_ext"></block>
      </category>
      <category name="Logic" colour="120">
        <block type="logic_compare"></block>
      </category>
      <category name="Math" colour="20">
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
        <block type="math_random"></block>
      </category>
      <category name="Text" colour="330">
        <block type="text"></block>
        <block type="text_print"></block>
      </category>
      <category name="Custom" colour="290">
        <block type="turtle_pen"></block>
        <block type="turtle_setcolor"></block>
        <block type="turtle_move"></block>
      </category>
    </xml>

    <xml id="toolboxSpawn" style="display: none">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_random" colour="290"></block>
      <block type="turtle_define" colour="290"></block>
    </xml>

    <xml id="turtle" style="display: none">
      <block type="turtle_define" deletable="false" movable="false">
        <value name="X">
          <block type="math_number">
            <field name="NUM">0</field>
          </block>
        </value>
        <value name="Y">
          <block type="math_number">
            <field name="NUM">0</field>
          </block>
        </value>
      </block>  
    </xml>

    <script type="text/javascript">
      // workspace
      var workspace = Blockly.inject('movementCodeDiv',
          {toolbox: document.getElementById('toolbox')});
          
      var workspaceSpawn = Blockly.inject('spawnCodeDiv', 
          {toolbox: document.getElementById('toolboxSpawn')});

      Blockly.Xml.domToWorkspace(document.getElementById('turtle'), workspaceSpawn);

      // particles
      var particles = [];
      var stepNumber = 0;
      var running = false;
      var requestedFrame = 0;

      var spawnCode = "";
      var movementCode = (particle) => {};

      var can = document.getElementById("tCanvas");
      can.initialize();
      var turtle = can.turtle;
      var canvas = can.canvas;
      var context = can.context;

      // custom buttons, turtle_penup
      Blockly.Blocks['turtle_pen'] = {
        /**
         * Block for pen up
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendDummyInput()
              .appendField('pen:')
              .appendField(new Blockly.FieldDropdown([
                             ['up', 'Up'],
                             ['down', 'Down']
                           ]),
                           'VALUE');
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };

      Blockly.JavaScript['turtle_pen'] = function(block) {
        // Generate JavaScript for setting pen up.
        var value = block.getFieldValue('VALUE');
        return 'turtle.pen' + value + '();\n';
      };

      // turtle_setcolor
      Blockly.Blocks['turtle_setcolor'] = {
        /**
         * Block for moving forward
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendValueInput('VALUE')
              .setCheck('Number') // validate
              .appendField('setColor');
          this.appendValueInput('VALUE1')
              .setCheck('Number'); // validate
          this.appendValueInput('VALUE2')
              .setCheck('Number'); // validate
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };


      Blockly.JavaScript['turtle_setcolor'] = function(block) {
        var value = Blockly.JavaScript.valueToCode(block, 'VALUE',
            Blockly.JavaScript.ORDER_NONE) || '0';
        var value1 = Blockly.JavaScript.valueToCode(block, 'VALUE1',
            Blockly.JavaScript.ORDER_NONE) || '0';
        var value2 = Blockly.JavaScript.valueToCode(block, 'VALUE2',
            Blockly.JavaScript.ORDER_NONE) || '0';
        return 'turtle.setColor' +
            '(' + value + ', ' + value1 + ', ' + value2 + ');\n';
      };

      // math_random
      Blockly.Blocks['math_random'] = {
        /**
         * Block for math random
         * @this Blockly.Block
         */
        init: function() {
          this.appendDummyInput()
              .appendField('Math.random()');
          this.setOutput(true, 'Number');
        }
      };

      Blockly.JavaScript['math_random'] = function(block) {
        // Generate JavaScript for setting math random.
        return 'Math.random()';
      };

      // turtle_forward
      Blockly.Blocks['turtle_move'] = {
        /**
         * Block for moving
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.setInputsInline(true);
          this.appendDummyInput()
              .appendField('move')
              .appendField(new Blockly.FieldDropdown([
                             ['forward', 'forward'],
                             ['backward', 'backward'],
                             ['left', 'left'],
                             ['right', 'right']
                           ]),
                           'DIRECTION');
          this.appendValueInput('VALUE');
          this.setPreviousStatement(true);
          this.setNextStatement(true);
        }
      };


      Blockly.JavaScript['turtle_move'] = function(block) {
        var direction = block.getFieldValue('DIRECTION');
        var value = block.getFieldValue('VALUE');

        return 'turtle.'+ direction +
            '(' + value + ');\n';
      };

      // turtle_forward
      Blockly.Blocks['turtle_define'] = {
        /**
         * Block for definition
         * @this Blockly.Block
         */
        init: function() {
          this.setColour(330);
          this.appendDummyInput()
              .appendField('pos:');
          this.appendValueInput('X')
              .setCheck('Number')
              .appendField('x:')
              .setAlign(Blockly.ALIGN_RIGHT);
          this.appendValueInput('Y')
              .setCheck('Number')
              .appendField('y:')
              .setAlign(Blockly.ALIGN_RIGHT);
        }
      };


      Blockly.JavaScript['turtle_define'] = function(block) {
        var x = block.getFieldValue('X');
        var y = block.getFieldValue('Y');

        return '(function() { return {pos: {x: '+ x +', y: ' + y + '}}; })()';
      };

      function saveSpawnCode()
      {
        this.spawnCode = "(function () { return " + document.getElementById("spawningCode").value + ";})()";
      }

      function saveMovementCode()
      {
        this.movementFunction = eval("(particle) => {" + Blockly.JavaScript.workspaceToCode(workspace) + "}");
      }

      function clearThis()
      {
        var color = document.getElementById("clearColor").value;
        can.clearCanvas(color);
      }

      function step()
      {
        clearThis();
        stepNumber++;

        var startTime = new Date();
        spawn();
        moveAndDraw();
        var endTime = new Date();

        var elapsed = endTime - startTime;
        var partCount = particles.length;

        document.getElementById("info").innerHTML = partCount.toString(10) + " Particles, " + elapsed.toString(10) + "ms";

        if (running)
          requestedFrame = requestAnimationFrame(step);
      }

      function spawn()
      {
        const targetCount = document.getElementById("particleCount").value;

        while (particles.length < targetCount)
        {
          var newParticle = eval(spawnCode);
          particles.push(newParticle);
        }

        if (particles.length > targetCount)
        {
          particles = particles.slice(0, targetCount);
        }
      }

      function moveAndDraw()
      {
        for (part of particles)
        {
          turtle.setState(part);
          movementFunction(part);
          part = part.assign(turtle.getState());
        }
      }

      function startSim()
      {
        saveMovementCode();
        requestedFrame = requestAnimationFrame(step);

        document.getElementById("StepButton").disabled = true;
        document.getElementById("StartButton").disabled = true;
        document.getElementById("PauseButton").disabled = false;

        running = true;
      }

      function pauseSim()
      {
        running = false;
        cancelAnimationFrame(requestedFrame);

        document.getElementById("StepButton").disabled = false;
        document.getElementById("StartButton").disabled = false;
        document.getElementById("PauseButton").disabled = true;
      }

      function reset()
      {
        if (running)
          pauseSim();
        particles = [];
        stepNumber = 0;
        clearThis();
        document.getElementById("info").innerHTML = "(reset)";
      }

      function init()
      {
        saveMovementCode();
        saveSpawnCode();

        var spawner = document.getElementById("spawningCode");
        // var mover = document.getElementById("movementCode");

        spawner.changeMode("javascript");
        spawner.customizeEditor();
        spawner.doSave = () => {saveSpawnCode()};

        // mover.changeMode("javascript");
        // mover.customizeEditor();
        // mover.doSave = () => {saveMovementCode()};
      };

      init();

    </script>
