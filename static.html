<html>
  <head>
    <meta charset="utf-8">
    <title>Particles</title>
    <link rel="stylesheet" href="https://lively-kernel.org/lively4/lively4-particles/css/index.css" media="screen">

    <script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-particles/google-blockly/blockly_compressed.js"></script>
    <script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-particles/google-blockly/javascript_compressed.js"></script>
    <script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-particles/google-blockly/msg/js/en.js"></script>
    <script type="text/javascript" src="https://lively-kernel.org/lively4/lively4-particles/blocks.js"></script>
  </head>
  <body>
    <lively-turtle-canvas id="tCanvas">
    Test
    </lively-turtle-canvas>
    <br>
    <button type="button" id="StepButton" onclick="step()">Step</button>
    <button type="button" id="StartButton" onclick="startSim()">Start</button>
    <button type="button" id="PauseButton" onclick="pauseSim()" disabled="">Pause</button>
    <button type="button" id="ResetButton" onclick="reset()">Reset</button>
    <br>
    <input type="number" id="particleCount" value="10">
    <br>
    <input id="clearColor" type="color" value="#FFFFFF">
    <br>
    <span id="info">0 Particles, 0ms</span>

    <div id="spawnCodeDiv" style="height: 200px; width: 850px;">
    </div>

    <div id="movementCodeDiv" style="height: 400px; width: 850px;"></div>

    <xml id="toolbox" style="display: none">
      <category name="Control" colour="210">
        <block type="controls_if"></block>
        <block type="controls_repeat_ext"></block>
      </category>
      <category name="Logic" colour="120">
        <block type="logic_compare"></block>
      </category>
      <category name="Math" colour="20">
        <block type="math_number"></block>
        <block type="math_arithmetic"></block>
        <block type="math_random_float"></block>
        <block type="math_random_int"></block>
      </category>
      <category name="Text" colour="330">
        <block type="text"></block>
        <block type="text_print"></block>
      </category>
      <category name="Custom" colour="290">
        <block type="turtle_pen"></block>
        <block type="turtle_setcolor"></block>
        <block type="turtle_move"></block>
        <block type="turtle_setheading"></block>
        <block type="turtle_getheading"></block>
      </category>
    </xml>

    <xml id="toolboxSpawn" style="display: none">
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_random_float"></block>
      <block type="math_random_int"></block>
    </xml>

    <xml id="turtleSpawn" style="display: none">
      <block type="turtle_define" deletable="false" movable="false">
        <value name="X">
          <block type="math_number">
            <field name="NUM">300</field>
          </block>
        </value>
        <value name="Y">
          <block type="math_number">
            <field name="NUM">400</field>
          </block>
        </value>
        <value name="HEADING">
          <block type="math_arithmetic">
            <value name="A">
              <block type="math_number">
                <field name="NUM">210</field>
              </block>
            </value>
            <value name="B">
              <block type="math_arithmetic">
                <value name="A">
                  <block type="math_random_float">
                  </block>
                </value>
                <value name="B">
                  <block type="math_number">
                    <field name="NUM">120</field>
                  </block>
                </value>
              </block>
            </value>
            <field name="OP">MULTIPLY</field>
          </block>
        </value>
      </block>
    </xml>

    <xml id="turtleMove" style="display: none">
      <block type="turtle_pen">
        <field name="VALUE">Down</field>
        <next>
          <block type="turtle_move">
            <field name="DIRECTION">forward</field>
            <value name="VALUE">
              <block type="math_number">
                <field name="NUM">10</field>
              </block>
            </value>
            <next>
              <block type="turtle_setcolor">
                <value name="X">
                  <block type="math_random_int">
                    <value name="FROM">
                      <block type="math_number">
                        <field name="NUM">200</field>
                      </block>
                    </value>
                    <value name="TO">
                      <block type="math_number">
                        <field name="NUM">255</field>
                      </block>
                    </value>
                  </block>
                </value>
                <value name="Y">
                  <block type="math_random_int">
                    <value name="FROM">
                      <block type="math_number">
                        <field name="NUM">1</field>
                      </block>
                    </value>
                    <value name="TO">
                      <block type="math_number">
                        <field name="NUM">155</field>
                      </block>
                    </value>
                  </block>
                </value>
                <value name="Z">
                  <block type="math_random_int">
                    <value name="FROM">
                      <block type="math_number">
                        <field name="NUM">1</field>
                      </block>
                    </value>
                    <value name="TO">
                      <block type="math_number">
                        <field name="NUM">155</field>
                      </block>
                    </value>
                  </block>
                </value>
                <next>
                  <block type="turtle_setheading">
                    <value name="VALUE">
                      <block type="math_arithmetic">
                        <value name="A">
                          <block type="math_number">
                            <field name="NUM">10</field>
                          </block>
                        </value>
                        <value name="B">
                          <block type="turtle_getheading">
                          </block>
                        </value>
                        <field name="OP">ADD</field>
                      </block>
                    </value>
                    <next>
                      <block type="controls_if">
                        <value name="IF0">
                          <block type="logic_compare">
                            <value name="A">
                              <block type="math_random_float">
                              </block>
                            </value>
                            <field name="OP">LT</field>
                            <value name="B">
                              <block type="math_number">
                                <field name="NUM">0.5</field>
                              </block>
                            </value>
                          </block>
                        </value>
                        <statement name="DO0">
                          <block type="turtle_move">
                            <field name="DIRECTION">left</field>
                            <value name="VALUE">
                              <block type="math_number">
                                <field name="NUM">10</field>
                              </block>
                            </value>
                          </block>
                        </statement>
                      </block>
                    </next>
                  </block>
                </next>
              </block>
            </next>
          </block>
        </next>
      </block>
    </xml>

    <script type="text/javascript">
      // workspace
      var workspace = Blockly.inject('movementCodeDiv',
          {toolbox: document.getElementById('toolbox')});
      workspace.addChangeListener((evt) => {saveMovementCode();});

      var workspaceSpawn = Blockly.inject('spawnCodeDiv',
          {toolbox: document.getElementById('toolboxSpawn')});
      workspaceSpawn.addChangeListener((evt) => {saveSpawnCode();});

      Blockly.Xml.domToWorkspace(document.getElementById('turtleMove'), workspace);    
      Blockly.Xml.domToWorkspace(document.getElementById('turtleSpawn'), workspaceSpawn);

      // particles
      var particles = [];
      var stepNumber = 0;
      var running = false;
      var requestedFrame = 0;

      var spawnCode = () => {};
      var movementCode = (particle) => {};

      var can = document.getElementById("tCanvas");
      can.initialize();
      var turtle = can.turtle;
      window.turtle = turtle;
      var canvas = can.canvas;
      var context = can.context;

      function saveSpawnCode()
      {
        var code = eval(Blockly.JavaScript.workspaceToCode(workspaceSpawn));
        this.spawnCode = code;
      }

      function saveMovementCode()
      {
        var code = "(particle) => {" + Blockly.JavaScript.workspaceToCode(workspace) + "}";
        this.movementFunction = eval(code);
      }

      function clearThis()
      {
        var color = document.getElementById("clearColor").value;
        can.clearCanvas(color);
      }

      function step()
      {
        //clearThis();
        stepNumber++;

        var startTime = new Date();
        spawn();
        moveAndDraw();
        var endTime = new Date();
        
        var elapsed = endTime - startTime;
        var partCount = particles.length;

        document.getElementById("info").innerHTML = partCount.toString(10) + " Particles, " + elapsed.toString(10) + "ms";

        if (running)
          requestedFrame = requestAnimationFrame(step);
      }

      function spawn()
      {
        const targetCount = document.getElementById("particleCount").value;

        while (particles.length < targetCount)
        {
          var newParticle = spawnCode();
          particles.push(newParticle);
        }

        if (particles.length > targetCount)
        {
          particles = particles.slice(0, targetCount);
        }
      }

      function moveAndDraw()
      {
        for (part of particles)
        {
          turtle.setState(part);
          movementFunction(part);
          part = Object.assign(part, turtle.getState());
        }
      }

      function startSim()
      {
        saveMovementCode();
        saveSpawnCode();
        
        //spawn();
        requestedFrame = requestAnimationFrame(step);

        document.getElementById("StepButton").disabled = true;
        document.getElementById("StartButton").disabled = true;
        document.getElementById("PauseButton").disabled = false;

        running = true;
      }

      function pauseSim()
      {
        running = false;
        cancelAnimationFrame(requestedFrame);

        document.getElementById("StepButton").disabled = false;
        document.getElementById("StartButton").disabled = false;
        document.getElementById("PauseButton").disabled = true;
      }

      function reset()
      {
        if (running)
          pauseSim();
        particles = [];
        stepNumber = 0;
        clearThis();
        document.getElementById("info").innerHTML = "(reset)";
      }

      function init()
      {
        saveMovementCode();
        saveSpawnCode();
      };

      init();

    </script>
  </body>
</html>